---
title: "NRES 776 Lecture 19"
subtitle: "GLM - multiple variables and Simpson's paradox"
author: Sunny Tseng
format:
  revealjs: 
    slide-number: true
    preview-links: auto
    #css: styles.css
    #footer: <https://quarto.org>
    theme: [default, styles.scss]
    #smaller: true
    #scrollable: true
    incremental: true
    embed-resources: true
    width: 1200
    fontsize: 1.7em
editor: visual
---

```{r setup}
library(tidyverse)
library(here)
library(lmtest)

binomial_data <- read_csv(here("Lectures", "Lecture 19 - multiple regression with GLM", "data", "isolation.csv"))
binomial_data <- binomial_data %>% 
  mutate(isolation = cut(isolation, breaks = c(2, 5, 7, 10), 
                         labels = c("low", "median", "high"))) %>%
  mutate(incidence = as_factor(incidence)) 


data("UCBAdmissions")
UCBAdmissions_clean <- UCBAdmissions %>%
  as_tibble() %>%
  pivot_wider(names_from = Admit, values_from = n) %>%
  mutate(Total = Admitted + Rejected,
         Rate = Admitted/Total)
```

## Our schedule today

-   Announcement (3 min)

    -   zoom recording

    -   topic for next week's lab

-   Wrap up (5 min)

## Research question (1 continuous x)

A survey was done on 50 islands for the incidence of a bird species Grasshopper Warbler. Researchers want to know whether the incidence is related to the area and/or the isolation level of the islands.

::: columns
::: {.column width="50%"}
### Use long format as input

```{r}
data_long <- binomial_data
data_long
```
:::

::: {.column width="50%"}
### Take a look at the relationship

```{r}
data_wide <- binomial_data %>%   
  group_by(isolation) %>%
  summarize(presence = sum(incidence == 1),  
            absence = sum(incidence == 0), 
            total = n(),                   
            proportion = presence/total,  
            mean_area = mean(area)) %>%     
  select(proportion, total, mean_area)   
data_wide
```
:::
:::

## Model formulation

$$ logit(p_i) = \beta_0 + \beta_1 x_{1i} $$

```{r, echo = TRUE}
incidence_binom <- glm(formula = incidence ~ area, 
                       data = data_long,  
                       family = "binomial")  
incidence_binom %>% summary
```

## Coef. interpretation

-   For island with area as 0 (baseline):

$$ logit(p_i) = log(\frac{p_i}{1-p_i})= \beta_0 $$

$$ \frac{p_i}{1-p_i} = Odd(p_i) = exp(\beta_0) = exp(-2.15) = 0.11 $$

-   The odd for the intercept is not often interpreted by itself.

## Coef. interpretation (con'd)

-   For island with non-0 area:

$$ logit(p_i) = \beta_0 + \beta_1 x_{1i}$$

$$ logit(p_i') = \beta_0 + \beta_1 (x_{1i} + 1)$$

$$ logit(p_i') - logit(p_i) = \beta_1 = log(\frac{Odd(p_i')}{Odd(p_i)}) $$

$$ \frac{Odd(p_i')}{Odd(p_i)} = exp(\beta_1) = exp(0.62) = 1.87  $$

-   For one unit increase in `area`, the odds of the bird species being present increase by a factor of 1.87.

## Output interpretation

### Odd ratio (OR)

-   $OR = 1$, no difference between groups
-   $OR < 1$, treatment decreases odds
-   $OR > 1$, treatment increases odds

### R output

-   **Intercept (-2.15)**: The odd of the bird being present on 0 area island is $exp(-2.15)$

-   **area (0.62)**: For one unit increase in `area`, the odds of the bird species being present increase by a factor of $exp(0.62)$

-   **Dispersion parameter (1)**: wonderful. Need to consider other methods if dispersion larger than 1 (over-dispersion) or smaller than 1 (under-dispersion)

-   **AIC (54.172)**: Can be used to compare the goodness of fit between models

## Model goodness of fit: Likelihood ratio test

```{r, echo = TRUE}
incidence_binom_null <- glm(formula = incidence ~ 1,
                            data = data_long,  
                            family = "binomial")
```

$H_0$: The model performance is the same as a null model (making predictions by chance)

$H_1$: The model performance is significantly different comparing to a null model

. . .

-   Use `lrtest()` function in the `lmtest` package

```{r, echo = TRUE}
lrtest(incidence_binom, incidence_binom_null)
```

## Model prediction

-   Use `predict()` and specify `type = "response"` to get back transformed $y_i$

```{r, echo = TRUE}
incidence_p <- data_long %>% 
  mutate(incidence_p = predict(incidence_binom, type = "response")) 
incidence_p
```

## Model visualization

```{r, echo = TRUE}
data_long %>%   
  mutate(incidence = incidence %>% as.numeric() - 1) %>%  
  ggplot(aes(x = area, y = incidence), data = .) +   
  geom_jitter(width = 0, height = 0.05) +  
  geom_smooth(method =  "glm",                
              method.args = list(family = "binomial"), 
              se = FALSE) +   
  labs(y = "Probability of incidence", x = "Area of an island")   
```

## Model visualization

```{r, echo = TRUE}
ggplot(aes(x = isolation, y = incidence_p),
       data = incidence_p) +   
  geom_boxplot() +   
  labs(y = "Probability of incidence", x = "Isolation level of island")
```

## UCB Admission data set

Aggregate data on applicants to graduate school at Berkeley for the six largest departments in 1973 classified by admission and sex.

![](images/Screenshot%202023-11-07%20091754.png){fig-align="center" width="669"}

## Exploratory data visualization

```{r, echo = TRUE}
apply(UCBAdmissions, c(1, 2), sum)
mosaicplot(apply(UCBAdmissions, c(1, 2), sum),
           main = "Student admissions at UC Berkeley")
```

## Model formulation (glm_1)

$$
logit(admission_i) = \beta_0 + \beta_1 genderM_i
$$

```{r, echo = TRUE}
glm_1 <- glm(formula = cbind(Admitted, Rejected) ~ Gender, 
             data = UCBAdmissions_clean, 
             family = "binomial")

glm_1 %>% summary
```

## Model goodness of fit

```{r, echo = TRUE}
glm_null <- glm(formula = cbind(Admitted, Rejected) ~ 1,
                data = UCBAdmissions_clean,
                family = "binomial")

lrtest(glm_1, glm_null)
```

## Coef. interpretation

$$
logit(p_i) = \beta_0 + \beta_1 genderM_i
$$

$$
\beta_1 = -0.83
$$

$$
\beta_1 = 0.61
$$

For female applicants:

$$
logit(p_F) =log(\frac{p_F}{1-p_F})= \beta_0
$$

$$
\frac{p_F}{1-p_F}= exp(\beta_0) = 0.43
$$

## Coef. interpretation (con'd)

For male applicants:

$$ logit(p_M) =log(\frac{p_M}{1-p_M})= \beta_0 + \beta_1$$

$$
\frac{p_M}{1-p_M}= exp(\beta_0 + \beta_1) 
$$

$$
\frac{Odd(p_M)}{Odd(p_F)} = exp(\beta_1) = 1.84
$$

-   Male students has 1.84 times higher odds in getting admitted in the university

-   Evidence of sex bias in admission practices!

## Model formulation (glm_2)

$$
logit(admission_i) = \beta_0 + \beta_1 genderM_i + \beta_2deptB_i + \beta_3deptC_i + \beta_4 deptD_i + beta_5 deptE_i + beta_6 deptF_i
$$

```{r, echo = TRUE}
glm_2 <- glm(formula = cbind(Admitted, Rejected) ~ Gender + Dept,
                data = UCBAdmissions_clean,
                family = "binomial")
glm_2 %>% summary()
```

## Model goodness of fit

```{r, echo = TRUE}
glm_null <- glm(formula = cbind(Admitted, Rejected) ~ 1,
                data = UCBAdmissions_clean,
                family = "binomial")

lrtest(glm_1, glm_null)
```

## Coef. interpretation

$$
logit(admission_i) = \beta_0 + \beta_1 genderM_i + \beta_2deptB_i + \beta_3deptC_i + \beta_4 deptD_i + beta_5 deptE_i + beta_6 deptF_i
$$

$$
\beta_0 = 0.6
$$

$$
\beta_1 = -0.09
$$

$$
\beta_2 = -0.04
$$

For female student in dept B:

$$
logit(p_{FB}) = log(\frac{p_{FB}}{1-p_{FB}})= \beta_0 + \beta_2
$$

$$
\frac{p_{FB}}{1-p_{FB}} = exp(\beta_0 + \beta_2) = 1.89
$$

## Coef. interpretation (con'd)

For male student in dept B:

$$
logit(p_{MB}) = log(\frac{p_{MB}}{1-p_{MB}})= \beta_0 + \beta_1 + \beta_2
$$

$$
\frac{p_{MB}}{1-p_{MB}}= exp(\beta_0 + \beta_1 + \beta_2) 
$$

\
$$
\frac{Odd(p_{MB})}{Odd(p_{FB})} = exp(\beta_1) = 0.9
$$

-   Male students has 0.9 times less odds in getting admitted in the department B

-   In general, male students has 0.9 times less odds in getting admitted in the university

-   Evidence of sex bias in admission practices! \<- no!

## Comparision between models

```{r, echo = TRUE}
glm_3 <- glm(formula = cbind(Admitted, Rejected) ~ Dept,
             data = UCBAdmissions_clean,
             family = "binomial")
```

-   `glm_null`: null model

-   `glm_1`: include Gender

-   `glm_2`: include Gender and Dept

-   `glm_3`: include Dept

```{r, echo = TRUE}
lrtest(glm_1, glm_2)
```

```{r, echo = TRUE}
lrtest(glm_2, glm_3)
```

## What is actually going on

-   Admission rate is actually influenced by department, not gender

-   Just happen to be that more male students applied to the department with higher admission rate

```{r, echo = TRUE}
opar <- par(mfrow = c(2, 3), oma = c(0, 0, 2, 0))
for(i in 1:6)
  mosaicplot(UCBAdmissions[,,i],
    xlab = "Admit", ylab = "Sex",
    main = paste("Department", LETTERS[i]))
mtext(expression(bold("Student admissions at UC Berkeley")),
      outer = TRUE, cex = 1.5)
par(opar)
```

## Simpson's Paradox

> A phenomenon in probability and statistics in which a trend appears in several groups of data but disappears or reverses when the groups are combined.

Which means, in a easier language, missing of important variable in a model.

![](https://paulvanderlaken.files.wordpress.com/2017/09/simpsonsparadox.png?w=1200){fig-align="center"}

## What we learned today

## Wrap up

### Before we meet again

-   

### Next time

-   Next Tuesday in person lecture with Lisa :)
